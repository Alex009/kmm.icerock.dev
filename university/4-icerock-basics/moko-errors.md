---
sidebar_position: 9
---

# Логирование и обработка ошибок

## Логирование

В проекте необходимо правильно логировать ошибки, потому что при выпуске приложения получается

Ситуация: сделали приложение, залилли в сторы, сидим довольные:
Через три дня видим сообщение от заказчика: юзеры жалуются в ЦПП, у них то вылетает, то не вылетает приолжение в разных местах, быстро чините!!!!

Мы хватаемся за голову, потому что все, что нам известно об ошибках - это то, что они происходят на тех-то и тех-то экранах, происходят рандомно, без стабильности.
Смотрим в код - вроде все норм, нигде явных косяков нет. Начали втупую гонять по экранам, в надеждах воспроизвести ошибку.

Пытаемся воспроизводить у себя, у нас все работает, ни одного креша целый день.
В конце концов кому-то удалось достичь креша, вот только он забыл запустить приложение с компа, поэтому плачем и всей командой опять носимся по экранам и пытаемся добиться креша, но теперь уже с логами об ошибке.

Наконец, спустя два дня, до ошибки мы таки добрались, оказалась - ***простецкая штука ПЕРЕПИСАТЬ***, исправили за 10 минут.

Согласитесь, каждый раз так мучиться - не вариант, никаких нервов не хватит.

Чтобы избежать этого, мы используем сервис [Firebase Crashlytics](https://firebase.google.com/docs/crashlytics), который позволяет получать данные обо всех ошибках, которые произошли у юзеров на устройствах, без каких либо телодвижений с их стороны.

Что нам дает его использование:
- отлавливать fatal и non-fatal ошибки
- fatal - произошел прям краш приложения
- non-fatal - произошла ошибка, однако, она как-то была обработана (try catch какой-нибудь был)

Теперь, когда нам позвонит заказчик и скажет: ребзя, опять крестьяне жалуются, чините а. Наш план будет следующим:
- открываем Firebase Crashlytics, видим, какая ошибка валится у пользователей, видим прям строчку с чего все полетело
- сразу разбираемся с причинами поломки конкретного места

Как поступать с fatal и non-fatal:
- fatal:
    - раз зафаталилось, значит нужен обработчик ошибки, раз они там могут появиться, + логгер в firebase, чтобы мы видили следующие ошибки в этом месие в firebase, но уже как non-fatal
- non-fatal:
    - раз нонфатал, значит мы там уже поставили обработчик и логгер в фаербейз, стало быть надо подумать вот о чем: Это шляпа какая-то (новая ошибка, из-за косяка в нашем коде) или обычное дело - ошибка, например, из-за отсутствия интернета, или чего-то такого, что естественно при каких-то входных данных может случиться (невозможность сохранить файл из-за остутствия свободной памяти на устройсте и тд)
    - В этом случае, если ошибка из серии нормальных и обычных, мы поставим услови, при котором будем логать ошибку в firebase - если она из серии тех, которые должны произойти (нет инета, нет места итд)
    - После этого, эти ошибки в крашлитиксе мы не увидим, а будем видеть только все те, которые не попали под условие + новые фаталы
    - Это поможет нам избавиться от свалки нонфаталов в крашлитиксе и, когда там что-то новое произойдет, мы сразу заметим и пойдем думать - исправлять код или также хайдить эту ошибку (тк она не потеряется в общей куче)

Для этих задач, чтобы ловить ошибки в общем коде мы используем библиотеку [Napier](https://github.com/AAkira/Napier), затем он связывается с FirebaseCrashlytics, после чего все логи Napier полетят в firebase

Также, чтобы лучше ориентироваться в логах, помимо ошибок иногда нужно использовать INFO - логировать какие-либо данные, которые могут помочь нам разобраться с ошибками, которые произойдут далее

## Обработка ошибок в общем коде

В любом мобильном приложении происходят ошибки. 
Некоторые из них не фатальны и, наоборот, полезны, например - ошибка запроса из-за отсутствия соединения. Такие ошибки нужно правильно обрабатывать, а не тупо скрывать, потому что тогда юзер так и не узнает, в чем проблема, хотя проблема банально в том, что он забыл включить интернет. 
Такие ошибки, как правило, показываются юзеру как аллерт или тост, чтобы юзер успел посмотреть, в чем проблема и, самое главное, попробовал решить ее самостоятельно. 
Также, сообщение о произошедшей ошибке должно содержать достаточно информации для ее решения, от сообщения ОШИБКА!!! об ошибке отсутсвия сети будет мало толку

Мы в IceRock используем для этого библиотеку [moko-errors](https://github.com/icerockdev/moko-errors).  
С ее помощью мы можем:
- настроить обработчик ошибок прямо в общем коде
- выбрать, как показывать ошибку юзеру (тост или алерт)
- Использовать разные строки для разных ошибок, прямо в общем коде

## Практическое задание

- склонируйте себе moko-errors
- запустите sample, потыкайте, посмотрите как работает, убедитесь что все работает на обеих платформах
- добавьте alertErrorPresenter, настройте, посмотрите как работает , убедитесь что все работает на обеих платформах
- добавьте свой класс ошибки, по аналогии с `CustomException`, добавьте свою строку локализации для отображения информации об этой ошибке, убедитесь что все работает на обеих платформах
- склонируйте себе mobile-moko-bolirplate, посмотрите как создается ExceptionMappersStorage, функция createExceptionHandler, как прокидывается в фбрику фичей
